<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI INST - Live Class</title>
    <!-- Component View CSS -->
    <link type="text/css" rel="stylesheet" href="https://source.zoom.us/3.5.2/css/bootstrap.css" />
    <link type="text/css" rel="stylesheet" href="https://source.zoom.us/3.5.2/css/react-select.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            background-color: #0f172a;
            /* Slate 900 */
            overflow: hidden;
        }

        #meetingSDKElement {
            width: 100%;
            height: 100%;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f172a;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 9999;
            flex-direction: column;
            transition: opacity 0.5s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <h3 id="statusText">Connecting to Live Class...</h3>
    </div>

    <!-- Container for Zoom Component View -->
    <div id="meetingSDKElement"></div>

    <!-- Zoom Meeting SDK Component View -->
    <script src="https://source.zoom.us/3.5.2/zoom-meeting-embedded-3.5.2.min.js"></script>

    <script>
        const loadingOverlay = document.getElementById('loadingOverlay');
        const statusText = document.getElementById('statusText');
        const client = ZoomMtgEmbedded.createClient();

        // Parse params
        const urlParams = new URLSearchParams(window.location.search);
        let meetingNumber = urlParams.get('meetingNumber');
        if (meetingNumber) meetingNumber = meetingNumber.replace(/[\s-]/g, '');

        const signature = urlParams.get('signature');
        const sdkKey = urlParams.get('sdkKey');
        const userName = urlParams.get('userName') || 'Student';
        const userEmail = urlParams.get('userEmail') || '';
        const password = urlParams.get('password') || '';

        console.log('=== ZOOM SDK INITIALIZATION ===');
        console.log('Meeting Number:', meetingNumber);
        console.log('Meeting Number (cleaned):', meetingNumber?.replace(/[\s-]/g, ''));
        console.log('SDK Key:', sdkKey?.substring(0, 10) + '...');
        console.log('Signature preview:', signature?.substring(0, 50) + '...');
        console.log('User Name:', userName);
        console.log('Password present:', !!password);

        async function startMeeting() {
            try {
                // Initialize the SDK
                await client.init({
                    zoomAppRoot: document.getElementById('meetingSDKElement'),
                    language: 'en-US',
                    customize: {
                        meetingInfo: ['topic', 'host', 'mn', 'participant', 'dc', 'enctype'],
                        video: {
                            isResizable: true,
                            viewSizes: {
                                default: { width: 1000, height: 600 },
                                ribbon: { width: 300, height: 600 }
                            }
                        }
                    }
                });

                console.log('SDK Inited, Joining...');

                // Join parameters
                const joinParams = {
                    sdkKey: sdkKey,
                    signature: signature,
                    meetingNumber: meetingNumber,
                    password: password,
                    userName: userName,
                    userEmail: userEmail,
                    tk: '',
                    zak: '' // Token passed if starting meeting on behalf of someone
                };

                await client.join(joinParams);

                console.log('Joined successfully');
                loadingOverlay.classList.add('hidden');

            } catch (error) {
                console.error('=== ZOOM SDK ERROR ===');
                console.error('Error object:', error);
                console.error('Error code:', error.errorCode);
                console.error('Error message:', error.message);
                console.error('Error reason:', error.reason);
                console.error('=== END ZOOM SDK ERROR ===');

                let errorMsg = 'Failed to join meeting';
                if (error.errorCode === 200) {
                    errorMsg = 'Meeting has not started yet. Please wait for the instructor.';
                } else if (error.errorCode === 3712) {
                    errorMsg = 'Invalid meeting number. Please contact support.';
                } else if (error.reason) {
                    errorMsg = 'Error: ' + error.reason;
                } else if (error.message) {
                    errorMsg = 'Error: ' + error.message;
                }

                statusText.innerText = errorMsg;
                statusText.style.color = '#ef4444';
            }
        }

        // Add event listeners for meeting status
        client.on('connection-change', (payload) => {
            console.log('Connection Status:', payload.state);
            if (payload.state === 'Connected') {
                loadingOverlay.classList.add('hidden');
            } else if (payload.state === 'Closed') {
                // Notify parent to close
                if (window.parent) {
                    window.parent.postMessage({ type: 'zoom-meeting-ended' }, '*');
                }
            }
        });

        // Start
        if (meetingNumber && signature && sdkKey) {
            startMeeting();
        } else {
            statusText.innerText = 'Missing meeting parameters';
            statusText.style.color = '#ef4444';
        }
    </script>
</body>

</html>